//******************************************************************************
#include <stdio.h>
#include <inttypes.h>
#include "stm32f4xx.h"
#include "stm32f4xx_conf.h"
#include "discoveryf4utils.h"
#include "uart_to_printf.h"
#include "stm32f4_discovery_sdio_sd.h"
#include "sdio_debug.h"
#include "diskio.h"
#include "ff.h"
#include "ff_debug.h"
//******************************************************************************

static uint8_t BuffMBR[] = { 0xFA, 0x33, 0xC0, 0x8E , 0xD0 , 0xBC , 0x00 , 0x7C , 0x8B , 0xF4 , 0x50 , 0x07 , 0x50 , 0x1F , 0xFB , 0xFC, \
	0xBF , 0x00 , 0x06 , 0xB9 , 0x00 , 0x01 , 0xF2 , 0xA5 , 0xEA , 0x1D , 0x06 , 0x00 , 0x00 , 0xBE , 0xBE , 0x07, \
	0xB3 , 0x04 , 0x80 , 0x3C , 0x80 , 0x74 , 0x0E , 0x80 , 0x3C , 0x00 , 0x75 , 0x1C , 0x83 , 0xC6 , 0x10 , 0xFE, \
	0xCB , 0x75 , 0xEF , 0xCD , 0x18 , 0x8B , 0x14 , 0x8B , 0x4C , 0x02 , 0x8B , 0xEE , 0x83 , 0xC6 , 0x10 , 0xFE, \
	0xCB , 0x74 , 0x1A , 0x80 , 0x3C , 0x00 , 0x74 , 0xF4 , 0xBE , 0x8B , 0x06 , 0xAC , 0x3C , 0x00 , 0x74 , 0x0B, \
	0x56 , 0xBB , 0x07 , 0x00 , 0xB4 , 0x0E , 0xCD , 0x10 , 0x5E , 0xEB , 0xF0 , 0xEB , 0xFE , 0xBF , 0x05 , 0x00, \
	0xBB , 0x00 , 0x7C , 0xB8 , 0x01 , 0x02 , 0x57 , 0xCD , 0x13 , 0x5F , 0x73 , 0x0C , 0x33 , 0xC0 , 0xCD , 0x13, \
	0x4F , 0x75 , 0xED , 0xBE , 0xA3 , 0x06 , 0xEB , 0xD3 , 0xBE , 0xC2 , 0x06 , 0xBF , 0xFE , 0x7D , 0x81 , 0x3D, \
	0x55 , 0xAA , 0x75 , 0xC7 , 0x8B , 0xF5 , 0xEA , 0x00 , 0x7C , 0x00 , 0x00 , 0x49 , 0x6E , 0x76 , 0x61 , 0x6C, \
	0x69 , 0x64 , 0x20 , 0x70 , 0x61 , 0x72 , 0x74 , 0x69 , 0x74 , 0x69 , 0x6F , 0x6E , 0x20 , 0x74 , 0x61 , 0x62, \
	0x6C , 0x65 , 0x00 , 0x45 , 0x72 , 0x72 , 0x6F , 0x72 , 0x20 , 0x6C , 0x6F , 0x61 , 0x64 , 0x69 , 0x6E , 0x67, \
	0x20 , 0x6F , 0x70 , 0x65 , 0x72 , 0x61 , 0x74 , 0x69 , 0x6E , 0x67 , 0x20 , 0x73 , 0x79 , 0x73 , 0x74 , 0x65, \
	0x6D , 0x00 , 0x4D , 0x69 , 0x73 , 0x73 , 0x69 , 0x6E , 0x67 , 0x20 , 0x6F , 0x70 , 0x65 , 0x72 , 0x61 , 0x74, \
	0x69 , 0x6E , 0x67 , 0x20 , 0x73 , 0x79 , 0x73 , 0x74 , 0x65 , 0x6D , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00, \
	0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00, \
	0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00, \
	0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00, \
	0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00, \
	0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00, \
	0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00, \
	0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00, \
	0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00, \
	0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00, \
	0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00, \
	0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00, \
	0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00, \
	0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00, \
	0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x80 , 0x01, \
	0x01 , 0x00 , 0x0B , 0x7F , 0xBF , 0xFD , 0x3F , 0x00 , 0x00 , 0x00 , 0xC1 , 0x40 , 0x5E , 0x00 , 0x00 , 0x00, \
	0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00, \
	0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00, \
	0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x00 , 0x55 , 0xAA  
};

//******************************************************************************
int main(void)
{
	/*!< At this stage the microcontroller clock setting is already configured,
	   this is done through SystemInit() function which is called from startup
	   file (startup_stm32f4xx.s) before to branch to application main.
	   To reconfigure the default setting of SystemInit() function, refer to
	   system_stm32f4xx.c file
	 */
// 	uint32_t i = 0;
// //	uint32_t k = 0;
// 	FATFS   fs;
	
	uint8_t Buff[512];
	SD_Error SDError = SD_OK;
	
// 	FRESULT fresult;
// 	FILINFO fno;
// 	DIR dir;
	
	STM_EVAL_LEDInit(LED_BLUE);
	STM_EVAL_LEDInit(LED_GREEN);
	STM_EVAL_LEDInit(LED_ORANGE);
	STM_EVAL_LEDInit(LED_RED);
	
	UART_Configuration();
	
	#ifdef SD_DMA_MODE
	SD_NVIC_Configuration();
	#endif
	
	printf("Disk initialize:\n");
	disk_initialize (0);
	
	printf("SD_ReadBlock:");
	//SDError = SD_ReadBlock(Buff, 0, 512);
	SDError = SD_ReadMultiBlocksFIXED(Buff, 0, 512, 1);
	
	SD_print_error(SDError);
// 	printf("SD_WaitReadOperation:");
// 	SDError = SD_WaitReadOperation();
// 	SD_print_error(SDError);
// 	while( SD_GetStatus() != SD_TRANSFER_OK );
	
  	print_adr_HEX_str(0,Buff);
	//printf("\n!!!%02x\n ",BuffMBR[0]);
	//print_adr_HEX_str(0,BuffMBR);
	//printf("\n!!!%02x ",BuffMBR[10]);
 	while(1);;
 	
	
	
	
// 	//SD_test();
// 	
// 	printf("Disk initialize:\n");
// 	disk_initialize (0);
// 	
// 	printf("f_mount:\n");
// 	fresult = f_mount(0, &fs);
// 	FR_print_error(fresult);
// 	
// 	
// 	
// 	//res = f_readdir(&dir, &fno);
// 	fresult = f_stat("123.txt",&fno);
// 	FR_print_error(fresult);
// 	while(1);;
// 	
// 	
// 	
// 	printf("Scan files:\n");
// 	scan_files("");
// 	scan_files("");
// 	scan_files("");
// 	scan_files("");
// 	scan_files("");
// 	scan_files("");
// 	
// 	f_mount(0, NULL);
// 	while(1) /* Infinite loop */
// 	{
// 		//STM_EVAL_LEDToggle(LED_BLUE);
// 		//STM_EVAL_LEDToggle(LED_GREEN);
// 		STM_EVAL_LEDToggle(LED_ORANGE);
// 		STM_EVAL_LEDToggle(LED_RED);
// 		for(i=0;i<0x01FFFFFF;++i){__NOP();};
// 		//printf("k = %i\n",k++);
// 	}
}
//******************************************************************************

